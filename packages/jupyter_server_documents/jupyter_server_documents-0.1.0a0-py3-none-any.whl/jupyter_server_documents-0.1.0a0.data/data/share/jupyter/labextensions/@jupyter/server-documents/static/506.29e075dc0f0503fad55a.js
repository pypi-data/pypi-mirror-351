"use strict";(self.webpackChunk_jupyter_server_documents=self.webpackChunk_jupyter_server_documents||[]).push([[506],{506:(e,t,o)=>{o.r(t),o.d(t,{default:()=>H,executionIndicator:()=>G,kernelStatus:()=>z,plugin:()=>J,rtcGlobalAwarenessPlugin:()=>q});var n=o(549),s=o(542),r=o(88),i=o(125),a=o(918),l=o(560),c=o(345),d=o.n(c),u=o(484);class h extends u.VDomRenderer{constructor(e,t=!0){super(new h.Model),this.translator=e||a.nullTranslator,this.addClass("jp-mod-highlighted")}render(){if(null!==this.model&&this.model.renderFlag){const e=this.model.currentNotebook;return e?d().createElement(r.ExecutionIndicatorComponent,{displayOption:this.model.displayOption,state:this.model.executionState(e),translator:this.translator}):d().createElement(r.ExecutionIndicatorComponent,{displayOption:this.model.displayOption,state:void 0,translator:this.translator})}return d().createElement("div",null)}}!function(e){class t extends r.ExecutionIndicator.Model{attachNotebook(e){var t;const o=null==e?void 0:e.content;if(!o)return;this._currentNotebook=o,this._notebookExecutionProgress.set(o,{executionStatus:"idle",kernelStatus:"idle",totalTime:0,interval:0,timeout:0,scheduledCell:new Set,scheduledCellNumber:0,needReset:!0});const n=this._notebookExecutionProgress.get(o);null===(t=null==o?void 0:o.model)||void 0===t||t.sharedModel.awareness.on("change",(e=>{var t;if(n){const e=null===(t=null==o?void 0:o.model)||void 0===t?void 0:t.sharedModel.awareness.getStates();if(e)for(const[,t]of e)if("kernel"in t)return n.kernelStatus=t.kernel.execution_state,void this.stateChanged.emit(void 0)}})),super.attachNotebook(e)}}e.Model=t}(h||(h={}));var p=o(963),g=o(689),v=o(186);async function y(e="",t={}){const o=v.ServerConnection.makeSettings(),n=g.URLExt.join(o.baseUrl,e.startsWith("/")?"":"jupyter-server-documents",e);let s;try{s=await v.ServerConnection.makeRequest(n,t,o)}catch(e){throw new v.ServerConnection.NetworkError(e)}let r=await s.text();if(r.length>0)try{r=JSON.parse(r)}catch(e){console.log("Not a JSON response body.",s)}if(!s.ok)throw new v.ServerConnection.ResponseError(s,r.message||r);return r}var m=o(559),_=o(0),w=o(442);const f=(0,_.createMutex)();m.CodeCellModel.prototype._onSharedModelChanged=function(e,t){t.streamOutputChange&&f((()=>{for(const e of t.streamOutputChange)"delete"in e&&this._outputs.removeStreamOutput(e.delete),"insert"in e&&this._outputs.appendStreamOutput(e.insert.toString())})),t.outputsChange&&f((()=>{var e;let o=0;for(const n of t.outputsChange){if("retain"in n&&(o+=n.retain),"delete"in n)for(let e=0;e<n.delete;e++)this._outputs.remove(o);if("insert"in n)for(const t of n.insert)if("toJSON"in t){const o=t.toJSON();(null===(e=o.metadata)||void 0===e?void 0:e.url)?y(o.metadata.url).then((e=>{this._outputs.add(e)})):this._outputs.add(o)}else this._outputs.add(t)}})),t.executionCountChange&&(!t.executionCountChange.newValue||!this.isDirty&&t.executionCountChange.oldValue||this._setDirty(!1),this.stateChanged.emit({name:"executionCount",oldValue:t.executionCountChange.oldValue,newValue:t.executionCountChange.newValue})),t.executionStateChange&&this.stateChanged.emit({name:"executionState",oldValue:t.executionStateChange.oldValue,newValue:t.executionStateChange.newValue}),t.sourceChange&&null!==this.executionCount&&this._setDirty(this._executedCode!==this.sharedModel.getSource().trim())},m.CodeCellModel.prototype.onOutputsChange=function(e,t){};class C extends w.OutputAreaModel{constructor(e={}){if(super({...e,values:[]}),e.values){const t=e.values.map((e=>{var t;return console.debug("output #${index}, value: ${value}"),(null===(t=e.metadata)||void 0===t?void 0:t.url)?y(e.metadata.url).then((e=>e)).catch((e=>(console.error("Error fetching output:",e),null))):Promise.resolve(e)}));Promise.all(t).then((e=>{console.log("After fetching from outputs service:"),e.forEach(((e,t)=>{if(console.debug("output #${index}, data: ${data}"),e&&!this.isDisposed){const t=this._add(e)-1;this.list.get(t).changed.connect(this._onGenericChange,this)}}))}))}}}m.CodeCellModel.ContentFactory.prototype.createOutputArea=function(e){return new C(e)};class b extends r.NotebookPanel.ContentFactory{createCodeCell(e){return new m.CodeCell(e).initializeState()}}var k=o(534),S=o(458),x=o(709),D=o(602),P=o(262),N=o(81);class I{constructor(e){this._onConnectionClosed=e=>{console.error("WebSocket connection was closed. Close event: ",e),(0,l.showErrorMessage)(this._trans.__("Document session error"),"Please refresh the browser tab.",[l.Dialog.okButton()]),this._sharedModel.dispose()},this._onSync=e=>{e&&(this._yWebsocketProvider&&(this._yWebsocketProvider.off("sync",this._onSync),this._sharedModel.ydoc.getMap("state").set("document_id",this._yWebsocketProvider.roomname)),this._ready.resolve())},this._ready=new P.PromiseDelegate,this._isDisposed=!1,this._path=e.path,this._contentType=e.contentType,this._format=e.format,this._serverUrl=e.url,this._sharedModel=e.model,this._awareness=e.model.awareness,this._yWebsocketProvider=null,this._trans=e.translator;const t=e.user;t.ready.then((()=>{this._onUserChanged(t)})).catch((e=>console.error(e))),t.userChanged.connect(this._onUserChanged,this),this._connect().catch((e=>console.warn(e)))}get isDisposed(){return this._isDisposed}get ready(){return this._ready.promise}get contentType(){return this._contentType}get format(){return this._format}dispose(){var e,t,o;this.isDisposed||(this._isDisposed=!0,null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(t=this._yWebsocketProvider)||void 0===t||t.off("sync",this._onSync),null===(o=this._yWebsocketProvider)||void 0===o||o.destroy(),this._disconnect(),D.Signal.clearData(this))}async reconnect(){this._disconnect(),this._connect()}async _connect(){const e=(await async function(e="",t={}){const o=v.ServerConnection.makeSettings(),n=g.URLExt.join(o.baseUrl,e);let s;try{s=await v.ServerConnection.makeRequest(n,t,o)}catch(e){throw new v.ServerConnection.NetworkError(e)}let r=await s.text();if(r.length>0)try{r=JSON.parse(r)}catch(e){console.error("Not a JSON response body.",s)}if(!s.ok)throw new v.ServerConnection.ResponseError(s,r.message||r);return r}(`api/fileid/index?path=${this._path}`,{method:"POST"})).id;this._yWebsocketProvider=new N.WebsocketProvider(this._serverUrl,`${this._format}:${this._contentType}:${e}`,this._sharedModel.ydoc,{disableBc:!0,awareness:this._awareness}),this._yWebsocketProvider.on("sync",this._onSync),this._yWebsocketProvider.on("connection-close",this._onConnectionClosed)}get wsProvider(){return this._yWebsocketProvider}_disconnect(){var e,t,o;null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(t=this._yWebsocketProvider)||void 0===t||t.off("sync",this._onSync),null===(o=this._yWebsocketProvider)||void 0===o||o.destroy(),this._yWebsocketProvider=null}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}const M="true"===g.PageConfig.getOption("disableRTC");class E extends v.RestContentProvider{constructor(e){super(e),this._onCreate=(e,t)=>{var o,n;if("string"==typeof e.format)try{const s=new I({url:g.URLExt.join(this._serverSettings.wsUrl,"api/collaboration/room"),path:e.path,format:e.format,contentType:e.contentType,model:t,user:this._user,translator:this._trans}),r=((null===(o=this._globalAwareness)||void 0===o?void 0:o.getLocalState())||{}).documents||[];r.includes(e.path)||(r.push(e.path),null===(n=this._globalAwareness)||void 0===n||n.setLocalStateField("documents",r));const i=`${e.format}:${e.contentType}:${e.path}`;this._providers.set(i,s),t.changed.connect((async(o,n)=>{var s;if(!n.stateChange)return;const r=n.stateChange.filter((e=>"hash"===e.name));if(0===r.length)return;r.length>1&&console.error("Unexpected multiple changes to hash value in a single transaction");const i=r[0],a=null!==(s=t.state.path)&&void 0!==s?s:e.path,l=await this.get(a,{content:!1});this._ydriveFileChanged.emit({type:"save",newValue:{...l,hash:i.newValue},oldValue:{hash:i.oldValue}})})),t.disposed.connect((()=>{var t,o;const n=this._providers.get(i);n&&(n.dispose(),this._providers.delete(i));const s=((null===(t=this._globalAwareness)||void 0===t?void 0:t.getLocalState())||{}).documents||[],r=s.indexOf(e.path);r>-1&&s.splice(r,1),null===(o=this._globalAwareness)||void 0===o||o.setLocalStateField("documents",s)}))}catch(t){console.error(`Failed to open websocket connection for ${e.path}.\n:${t}`)}},this._ydriveFileChanged=new D.Signal(this),this._user=e.user,this._trans=e.trans,this._globalAwareness=e.globalAwareness,this._serverSettings=e.serverSettings,this.sharedModelFactory=new T(this._onCreate),this._providers=new Map}get providers(){return this._providers}async get(e,t){if(t&&t.format&&t.type){const o=`${t.format}:${t.type}:${e}`,n=this._providers.get(o);if(n){const[o]=await Promise.all([super.get(e,{...t,content:!1}),n.ready]);return{...o,format:t.format}}}return super.get(e,t)}async save(e,t={}){if(t.format&&t.type){const o=`${t.format}:${t.type}:${e}`;if(this._providers.get(o)){const o={type:t.type,format:t.format,content:!1};return this.get(e,o)}}return super.save(e,t)}get fileChanged(){return this._ydriveFileChanged}}class T{constructor(e){this._onCreate=e,this.collaborative=!M,this.documentFactories=new Map}registerDocumentFactory(e,t){if(this.documentFactories.has(e))throw new Error(`The content type ${e} already exists`);this.documentFactories.set(e,t)}createNew(e){if("string"==typeof e.format){if(this.collaborative&&e.collaborative&&this.documentFactories.has(e.contentType)){const t=this.documentFactories.get(e.contentType)(e);return this._onCreate(e,t),t}}else console.warn(`Only defined format are supported; got ${e.format}.`)}}const $="The file %1 has been opened with two different views. This is not supported. Please close this view; otherwise, some of your edits may not be saved properly.",A={id:"@jupyter/server-documents/docprovider-extension:content-provider",description:"The RTC content provider",provides:x.ICollaborativeContentProvider,requires:[a.ITranslator],optional:[x.IGlobalAwareness],activate:(e,t,o)=>{const n=t.load("jupyter_collaboration"),s=e.serviceManager.contents.defaultDrive;if(!s)throw Error("Cannot initialize content provider: default drive property not accessible on contents manager instance.");const r=s.contentProviderRegistry;if(!r)throw Error("Cannot initialize content provider: no content provider registry.");const i=new E({apiEndpoint:"/api/contents",serverSettings:s.serverSettings,user:e.serviceManager.user,trans:n,globalAwareness:o});return r.register("rtc",i),i}},W={id:"@jupyter/server-documents/docprovider-extension:yfile",description:"Plugin to register the shared model factory for the content type 'file'",autoStart:!0,requires:[x.ICollaborativeContentProvider,k.IEditorWidgetFactory],activate:(e,t,o)=>{t.sharedModelFactory.registerDocumentFactory("file",(()=>new _.YFile)),o.contentProviderId="rtc"}},F={id:"@jupyter/server-documents/docprovider-extension:ynotebook",description:"Plugin to register the shared model factory for the content type 'notebook'",autoStart:!0,requires:[x.ICollaborativeContentProvider,r.INotebookWidgetFactory],optional:[s.ISettingRegistry],activate:(e,t,o,n)=>{let s=!0;n&&n.load("@jupyterlab/notebook-extension:tracker").then((e=>{const t=e=>{const t=null==e?void 0:e.get("experimentalEnableDocumentWideUndoRedo").composite;s=!(null!=t&&t)};t(e),e.changed.connect((e=>t(e)))})),t.sharedModelFactory.registerDocumentFactory("notebook",(()=>new _.YNotebook({disableDocumentWideUndoRedo:s}))),o.contentProviderId="rtc"}},j={id:"@jupyter/server-documents/docprovider-extension:logger",description:"A logging plugin for debugging purposes.",autoStart:!0,optional:[S.ILoggerRegistry,k.IEditorTracker,r.INotebookTracker,a.ITranslator],activate:(e,t,o,n,s)=>{const r=(null!=s?s:a.nullTranslator).load("jupyter_collaboration"),i="https://schema.jupyter.org/jupyter_collaboration/session/v1";if(!t)return void e.serviceManager.events.stream.connect(((e,t)=>{var o,n;t.schema_id===i&&(console.debug(`[${t.room}(${t.path})] ${null!==(o=t.action)&&void 0!==o?o:""}: ${null!==(n=t.msg)&&void 0!==n?n:""}`),"WARNING"===t.level&&(0,l.showDialog)({title:r.__("Warning"),body:r.__($,t.path),buttons:[l.Dialog.okButton()]}))}));const c=new Map,d=(e,o)=>{const n=t.getLogger(o.context.path);c.set(o.context.localPath,n),o.disposed.connect((e=>{c.delete(e.context.localPath)}))};o&&o.widgetAdded.connect(d),n&&n.widgetAdded.connect(d),(async()=>{var t,o;const{events:n}=e.serviceManager;for await(const e of n.stream)if(e.schema_id===i){const n=c.get(e.path);null==n||n.log({type:"text",level:e.level.toLowerCase(),data:`[${e.room}] ${null!==(t=e.action)&&void 0!==t?t:""}: ${null!==(o=e.msg)&&void 0!==o?o:""}`}),"WARNING"===e.level&&(0,l.showDialog)({title:r.__("Warning"),body:r.__($,e.path),buttons:[l.Dialog.warnButton({label:r.__("Ok")})]})}})()}};var R=o(826),O=o(206),L=o(381);class V extends N.WebsocketProvider{constructor(e){super(e.url,e.roomID,e.awareness.doc,{awareness:e.awareness}),this._isDisposed=!1,this._awareness=e.awareness,this._user=e.user,this._user.ready.then((()=>this._onUserChanged(this._user))).catch((e=>console.error(e))),this._user.userChanged.connect(this._onUserChanged,this)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._user.userChanged.disconnect(this._onUserChanged,this),this._isDisposed=!0,this.destroy())}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}function U(e){const t=(e.translator||a.nullTranslator).load("jupyterlab");let o="";return e.status&&(o=` | ${e.status}`),d().createElement(i.TextItem,{onClick:e.handleClick,onKeyDown:e.handleKeyDown,source:`${e.kernelName}${o}`,title:t.__("Change kernel for %1",e.activityName),tabIndex:0})}class K extends u.VDomRenderer{constructor(e,t){super(new K.Model(t)),this.translator=t||a.nullTranslator,this._handleClick=e.onClick,this._handleKeyDown=e.onKeyDown,this.addClass("jp-mod-highlighted")}render(){return null===this.model?null:d().createElement(U,{status:this.model.status,kernelName:this.model.kernelName,activityName:this.model.activityName,handleClick:this._handleClick,handleKeyDown:this._handleKeyDown,translator:this.translator})}}!function(e){class t extends l.KernelStatus.Model{attachDocument(e){var t;if(!e)return;const o=e;null===(t=o.model)||void 0===t||t.sharedModel.awareness.on("change",(()=>{var e;if(this){const t=null===(e=null==o?void 0:o.model)||void 0===e?void 0:e.sharedModel.awareness.getStates();if(t)for(const[,e]of t)if("kernel"in e)return this._kernelStatus=e.kernel.execution_state,void this.stateChanged.emit(void 0)}}))}set sessionContext(e){var t;const o=this._getAllState();this._sessionContext=e,this._kernelName=null!==(t=null==e?void 0:e.kernelDisplayName)&&void 0!==t?t:this._trans.__("No Kernel"),this._triggerChange(o,this._getAllState()),null==e||e.kernelChanged.connect(this._onKernelDisplayNameChanged,this)}_onKernelDisplayNameChanged(e,t){const o=this._getAllState();this._kernelName=e.kernelDisplayName,this._triggerChange(o,this._getAllState())}}e.Model=t}(K||(K={}));const J={id:"@jupyter/server-documents:plugin",description:"A JupyterLab extension that provides RTC capabilities.",autoStart:!0,optional:[s.ISettingRegistry],activate:(e,t)=>{console.log("JupyterLab extension @jupyter/server-documents is activated!"),t&&t.load(J.id).then((e=>{console.log("@jupyter/server-documents settings loaded:",e.composite)})).catch((e=>{console.error("Failed to load settings for @jupyter/server-documents.",e)})),y("get-example").then((e=>{console.log(e)})).catch((e=>{console.error(`The jupyter_server_documents server extension appears to be missing.\n${e}`)}))}},q={id:"@jupyter/server-documents/collaboration-extension:rtcGlobalAwareness",description:"Add global awareness to share working document of users.",requires:[R.IStateDB],provides:x.IGlobalAwareness,activate:(e,t)=>{const{user:o}=e.serviceManager,n=new O.Doc,s=new L.ww(n),r=v.ServerConnection.makeSettings(),i=g.URLExt.join(r.wsUrl,"api/collaboration/room");return new V({url:i,roomID:"JupyterLab:globalAwareness",awareness:s,user:o}),t.changed.connect((async()=>{var e,o;const n=(null===(o=null===(e=(await t.toJSON())["layout-restorer:data"])||void 0===e?void 0:e.main)||void 0===o?void 0:o.current)||"";n.match(/^\w+:.+/)?s.setLocalStateField("current",n):s.setLocalStateField("current",null)})),s}};class B{createNew(e){const t=new h,o=e.content;return t.model.attachNotebook({content:o}),e.toolbar.insertAfter("kernelName","awarenessExecutionProgress",t),t}}const G={id:"@jupyter/server-documents:awareness-execution-indicator",description:"Adds a notebook execution status widget.",autoStart:!0,requires:[r.INotebookTracker,n.ILabShell,a.ITranslator,l.IToolbarWidgetRegistry],optional:[i.IStatusBar,s.ISettingRegistry],activate:(e,t,o,n,s,r,i)=>{console.log("JupyterLab extension activated: Awareness Execution Indicator"),e.docRegistry.addWidgetExtension("Notebook",new B)}},z={id:"@jupyterlab/apputils-extension:awareness-kernel-status",description:"Provides the kernel status indicator model.",autoStart:!0,requires:[i.IStatusBar],provides:l.IKernelStatusModel,optional:[l.ISessionContextDialogs,a.ITranslator,n.ILabShell],activate:(e,t,o,n,s)=>{console.log("JupyterLab extension activated: Awareness Kernel Status Indicator");const r=null!=n?n:a.nullTranslator,i=null!=o?o:new l.SessionContextDialogs({translator:r}),c=async()=>{d.model.sessionContext&&await i.selectKernel(d.model.sessionContext)},d=new K({onClick:c,onKeyDown:async e=>{if("Enter"===e.key||"Spacebar"===e.key||" "===e.key)return e.preventDefault(),e.stopPropagation(),c()}},r),u=new Set;function h(e,t){var o;const{oldValue:n,newValue:s}=t;n&&n.title.changed.disconnect(p),d.model.attachDocument(s),d.model.sessionContext=null!==(o=[...u].map((e=>e(t.newValue))).filter((e=>null!==e))[0])&&void 0!==o?o:null,s&&d.model.sessionContext&&(p(s.title),s.title.changed.connect(p))}const p=e=>{d.model.activityName=e.label};return s&&s.currentChanged.connect(h),t.registerStatusItem(z.id,{priority:1,item:d,align:"left",rank:1,isActive:()=>!0}),{addSessionProvider:t=>{u.add(t),e.shell.currentWidget&&h(e.shell,{newValue:e.shell.currentWidget,oldValue:null})}}}},Y={id:"@jupyter/server-documents/notebook-extension:factory",description:"Provides the notebook cell factory.",provides:r.NotebookPanel.IContentFactory,requires:[p.IEditorServices],autoStart:!0,activate:(e,t)=>{const o=t.factoryService.newInlineEditor;return new b({editorFactory:o})}},H=[A,W,F,j,q,J,G,z,Y]}}]);
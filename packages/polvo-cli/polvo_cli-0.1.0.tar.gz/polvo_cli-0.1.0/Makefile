# Default target
.DEFAULT_GOAL := help

# Silent mode
MAKEFLAGS += -s

# Variables
BASE_BRANCH ?= main
COVERAGE_FILE ?= coverage.xml
VENV_NAME ?= venv
PYTHON ?= python3

# Help target
help:
	@echo "Available commands:"
	@echo "âšˆ venv			---> ğŸ Create virtual environment"
	@echo "âšˆ install		---> ğŸ“¦ Install all dependencies"
	@echo "âšˆ install-build		---> ğŸ”§ Install build dependencies"
	@echo "âšˆ test			---> ğŸ§ª Run tests with coverage"
	@echo "âšˆ benchmark		---> ğŸ“Š Run performance benchmarks"
	@echo "âšˆ tox			---> ğŸ”„ Run tests in multiple Python environments"
	@echo "âšˆ tox-py-%		---> ğŸ Run tox for specific Python version (e.g., tox-py-39)"
	@echo "âšˆ diff-cover		---> ğŸ“Š Run tests and check coverage diff against base branch"
	@echo "âšˆ diff-cover-only	---> ğŸ” Check coverage diff only against base branch"
	@echo "âšˆ fmt			---> ğŸ¨ Format code using black"
	@echo "âšˆ sort			---> â¬‡ï¸  Sort requirements and env files alphabetically"
	@echo "âšˆ freeze		---> ğŸ§Š Freeze requirements to their exact versions"
	@echo "âšˆ clean			---> ğŸ§¹ Remove all build, test, and cache files"
	@echo "âšˆ clean-build		---> ğŸ—‘ï¸  Remove build artifacts"
	@echo "âšˆ build			---> ğŸ“¦ Build package distribution"
	@echo "âšˆ publish		---> ğŸš€ Build and publish package to main repository"
	@echo "âšˆ publish-test		---> ğŸ§ª Build and publish package to test repository"
	@echo "âšˆ bump-patch		---> ğŸ“ Bump patch version (0.0.x)"
	@echo "âšˆ bump-minor		---> ğŸ“Œ Bump minor version (0.x.0)"
	@echo "âšˆ bump-major		---> ğŸ“ˆ Bump major version (x.0.0)"
	@echo "âšˆ clean-venv		---> ğŸ—‘ï¸  Remove virtual environment"
	@echo "âšˆ clean-all		---> ğŸ§¹ Clean everything including virtual environment"

# Virtual environment targets
venv:
	@echo "ğŸ Creating virtual environment..."
	@if [ ! -d "$(VENV_NAME)" ]; then \
		$(PYTHON) -m venv $(VENV_NAME); \
		echo "âœ… Virtual environment created at $(VENV_NAME)/"; \
		echo "ğŸ’¡ Activate it with: source $(VENV_NAME)/bin/activate"; \
	else \
		echo "âš ï¸  Virtual environment already exists at $(VENV_NAME)/"; \
	fi

# Installation targets
install:
	@echo "ğŸ“¦ Installing dependencies..."
	@if [ ! -d "$(VENV_NAME)" ]; then \
		echo "âš ï¸  Virtual environment not found. Creating it first..."; \
		make venv; \
	fi
	@echo "ğŸ“¦ Installing project in development mode with dev dependencies..."
	pip install -e ".[dev]"

install-build:
	@echo "ğŸ”§ Installing build dependencies..."
	pip install -e ".[build]"

# Testing targets
test:
	@echo "\n> ğŸ§ª Running tests...\n"
	cd src && python -m pytest ../tests -vv --cov=./ --cov-report=xml --cov-config=../.coveragerc -m "not performance"

benchmark:
	@echo "\n> ğŸ“Š Running performance tests...\n"
	cd src && python -m pytest ../tests --cov=./ --cov-report=xml --cov-config=../.coveragerc -m "performance" --benchmark-only

tox:
	@echo "ğŸ”„ Running tox tests..."
	cd src && tox

tox-py-%:
	@echo "ğŸ Running tox for Python $*..."
	cd src && tox -e py$*

# Coverage targets
ensure-diff-cover:
	@echo "\n> ğŸ” Checking for diff-cover...\n"
	@if ! command -v diff-cover &> /dev/null; then \
		echo "diff-cover not found. Installing..."; \
		pip install diff-cover; \
	else \
		echo "diff-cover is already installed."; \
	fi

diff-cover-only: ensure-diff-cover
	@echo "\n> ğŸ“Š Running diff-cover on existing coverage file...\n"
	@echo "Comparing against base branch: $(BASE_BRANCH)"
	@echo "Using coverage file: $(COVERAGE_FILE)"
	@if [ ! -f "$(COVERAGE_FILE)" ]; then \
		echo "Error: Coverage file $(COVERAGE_FILE) does not exist."; \
		echo "* Suggestion: Run 'make diff-cover' to generate coverage file first."; \
		exit 1; \
	fi
	@git fetch origin $(BASE_BRANCH)
	@diff-cover "$(COVERAGE_FILE)" --compare-branch="$(BASE_BRANCH)" --fail-under=80 \
		--exclude="**/test_*.py" --exclude="**/tests/**" --exclude="**/examples/**"

diff-cover: test diff-cover-only
	@echo "\n> ğŸ‰ Tests and diff-cover completed.\n"

# Cleanup targets
clean-build:
	@echo "ğŸ—‘ï¸ Cleaning build artifacts..."
	rm -rf src/dist build dist *.egg-info
	
clean-venv:
	@echo "ğŸ—‘ï¸ Removing virtual environment..."
	rm -rf $(VENV_NAME)

clean: clean-build
	@echo "ğŸ§¹ Cleaning all artifacts..."
	rm -rf __pycache__ .tox .pytest_cache .coverage
	find . -type d -name "__pycache__" -exec rm -r {} +

clean-all: clean clean-venv
	@echo "ğŸ§¹ Cleaning everything including virtual environment..."

# Build and publish targets
build: clean-build
	@echo "ğŸ“¦ Building package..."
	python -m build

publish-test: build
	@echo "ğŸ§ª Publishing to test repository..."
	python -m twine upload --repository polvo-cli-test dist/*

publish: build
	@echo "ğŸš€ Publishing to main repository..."
	python -m twine upload --repository polvo-cli dist/* --verbose

# Version bump targets
bump-patch:
	@echo "ğŸ“ Bumping patch version..."
	bump2version patch --verbose

bump-minor:
	@echo "ğŸ“Œ Bumping minor version..."
	bump2version minor --verbose

bump-major:
	@echo "ğŸ“ˆ Bumping major version..."
	bump2version major --verbose

.PHONY: help venv venv-activate install install-build test benchmark tox tox-py-% diff-cover diff-cover-only \
	fmt sort freeze clean clean-build clean-venv clean-all build publish publish-test \
	bump-patch bump-minor bump-major
